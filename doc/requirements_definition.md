# 要件定義書: Wikidot タグリスト解析システム

## 1. 目的

SCP 財団日本語 Wiki の「タグリスト」ページ（Wikidot ソース）を解析し、各タグに関する以下の情報を網羅的に抽出し、構造化された JSON ファイルとして出力するシステムの要件を定義します。

- タグ名（日本語）
- タグスラッグ（URL に使われる識別子）
- 英語タグ名（存在する場合）
- 説明文（Wikidot 構文を含む生データと、構文を除去したプレーンテキスト）
- カテゴリ階層
- 制限タグ情報（アイコンとその意味）
- メタ情報（説明文中の Wikidot リンク、関連タグ、対象ページ種別、注釈など）

この JSON ファイルは、Wikidot ソースを直接参照せずとも、タグシステムの全体像と詳細を理解し、関連ツールやシステムを設計・実装するために十分な情報を提供することを目的とします。

## 2. 背景

- SCP 財団日本語 Wiki のタグリストは Wikidot プラットフォーム上で管理されており、その内容は日々更新される可能性があります。
- タグには、他言語版からの翻訳タグ（英語名が併記されることが多い）と、日本支部オリジナルのタグが存在します。
- 各タグの説明文には、単純なテキストだけでなく、Wikidot 独自の構文（リンク、脚注、装飾など）や、他のタグとの関連性を示唆する自然言語表現が豊富に含まれています。
- 既存の解析スクリプト (`src/parse_jp_tags.py`) は基本的なタグ情報抽出機能を有しますが、説明文に含まれる詳細なメタ情報の抽出には対応していない可能性があります。

## 3. スコープ

- **対象:** SCP 財団日本語 Wiki のタグリスト Wikidot ソース。具体的には `data/raw/wikidot_sources/scp-jp/tag-list.txt` を起点とし、`[[include]]` で再帰的に展開される全ての `fragment_*.txt` ファイルを含みます。
- **対象外:**

  * Wikidot ソースファイルの取得およびローカルへの保存処理（これらは既存の Python ライブラリ等で完了している前提）。

  * 英語版タグリスト (`05command_tech-hub-tag-list.txt` など) の解析処理。

  * 抽出したタグ情報を用いた翻訳機能の実装。

  * ユーザーインターフェース (UI) の開発。

## 4. 機能要件

システムの主要な機能要件を以下に示します。

```mermaid

graph TD

    A[Wikidotソース読み込み] --> B(Include展開処理);

    B --> C{完全なソーステキスト};

    C --> D(行単位での解析);

    D --> E{カテゴリ抽出};

    D --> F{タグ定義行 判定};

    F -- Yes --> G(基本情報抽出);

    G --> H[スラッグ];

    G --> I[日本語名];

    G --> J[英語名(Optional)];

    G --> K[生の説明文];

    G --> L[制限アイコン(Optional)];

    F -- Yes --> M(説明文 詳細解析);

    M --> N[Wikidotリンク抽出];

    M --> O[関連タグ言及 抽出];

    M --> P[対象ページ種別 推測];

    M --> Q[脚注 抽出];

    M --> R[その他メタ情報 抽出];

    M --> S[プレーンテキスト生成];

    E & H & I & J & K & L & N & O & P & Q & R & S --> T{タグデータ構造化};

    T --> U(JSONファイル出力);

  

    subgraph 説明文解析

        direction LR

        M --> N;

        M --> O;

        M --> P;

        M --> Q;

        M --> R;

        M --> S;

    end

  

    subgraph 基本情報抽出

        direction LR

        G --> H;

        G --> I;

        G --> J;

        G --> K;

        G --> L;

    end

```

- **4.1 Wikidot ソース展開:**

  * 起点ファイル (`tag-list.txt`) を読み込みます。

  * `[[include :scp-jp:fragment:…]]` 構文を検出し、指定されたフラグメントファイルを再帰的に読み込み、展開します。

  * 展開処理中にファイルの循環参照を検出し、無限ループを防止します。

  * 展開後の完全な Wikidot ソーステキストをメモリ上に構築します。

- **4.2 カテゴリ抽出:**

  * `+ タイトル[[# id]]` や `++ サブタイトル` の形式の行を検出し、カテゴリ名と階層レベル（1 or 2）を抽出します。

  * 解析中のコンテキストとして現在のカテゴリ階層を維持します（例: `["基本的なタグ", "創作物"]`）。

- **4.3 タグ基本情報抽出:**

  * `* … [[[/system:page-tags/tag/スラッグ|日本語タグ名]]] …` というパターンを持つ行をタグ定義行として特定します。

  * タグ定義行から以下の情報を抽出します。

    * **スラッグ:** `[[[/system:page-tags/tag/` と `|` の間の文字列。

    * **日本語名:** `|` と `]]]` の間の文字列。

    * **英語名:** `//(` と `)//` の間の文字列（存在する場合のみ）。存在しない場合は `null`。

    * **生の説明文:** タグ定義の末尾（通常は `-` の後）から行末までの文字列。Wikidot 構文はそのまま保持します。

    * **制限アイコン:** タグ名の直前にある `,,アイコン,,` パターン（存在する場合のみ）。

- **4.4 メタ情報抽出（説明文解析）:**

  * 抽出した「生の説明文」をさらに解析し、以下のメタ情報を抽出します。

    * **Wikidot リンク:** `[[[page-slug|表示名]]]`, `[[[page-slug]]]` などのパターンを検出し、リンク先のページスラッグと表示名を抽出します。

    * **関連タグ:** 「`//hoge//` タグと併用」、「`fuga` タグを参照」、「`piyo` タグの代わりに使用」などの自然言語パターンや、説明文中の `[[[/system:page-tags/tag/…]]]` リンクを解析し、関連するタグのスラッグと関係性（併用不可、参照推奨、代替推奨など）を抽出します。

    * **対象ページ種別:** 「〜の記事に付与されるタグです」のような記述から、そのタグが主にどのような種類のページ（scp, tale, goi-format, ガイドなど）に適用されるかを推測・抽出します。

    * **脚注:** `[[footnote]]` と `[[/footnote]]` で囲まれた部分を注釈として抽出します。

    * **その他:** 上記以外で、説明文から抽出可能な有用な情報（例: 特定の条件下でのみ使用可能、など）。

  * 生の説明文から Wikidot 構文（リンク、太字、斜体、脚注など）を除去し、プレーンテキストの説明文を生成します。

- **4.5 制限タグ情報解釈:**

  * 抽出した制限アイコン（例: `︁`, ``, ``）に対応する意味（使用禁止, 編集禁止, 制限緩和/翻訳）を付与します。アイコンと意味の対応表は `fragment_tag-list-basic.txt` の冒頭定義に基づきます。

- **4.6 データ構造化:**

  * 抽出した全ての情報（基本情報、カテゴリ、メタ情報、制限情報）を、タグごとに一意なデータ構造（Python の辞書やクラスオブジェクト）に整理・格納します。

- **4.7 JSON 出力:**

  * 構造化されたタグデータのリストを、指定されたフォーマットの JSON ファイルとして出力します。

  * ファイルエンコーディングは UTF-8 とし、日本語文字が正しく表示されるようにします (`ensure_ascii=False`)。

  * 人間が読みやすいように、適切なインデントを付与します (`indent=2`)。

## 5. 非機能要件

- **正確性:** Wikidot ソースの構文、特にタグ定義、英語名、カテゴリ階層、制限アイコンの抽出精度を最優先します。
- **網羅性:** タグリストに含まれる全てのタグを対象とし、説明文中のメタ情報も可能な限り網羅的に抽出することを目指します。
- **柔軟性:** Wikidot の記述の揺れ（例: スペースの有無、全角/半角記号）や、将来的な軽微な書式変更に対して、ある程度ロバスト（頑健）であるように設計します。正規表現の工夫や、必要であればより高度なパーサーの導入を検討します。
- **保守性:** Python コードは型ヒントを活用し、関数やクラスを適切に分割するなど、可読性と保守性を高めるように記述します。設定値（入力パス、出力パス、正規表現パターンなど）は分離して管理しやすくします。
- **性能:** 大量のタグ情報（数百〜千件規模）を処理するため、極端に低速にならないよう、効率的なファイル読み込み、正規表現の最適化、データ構造の選択などを考慮します。

## 6. 出力 JSON フォーマット（案）

```json

[

  {

    "slug": "scp", // タグスラッグ (必須)

    "name_jp": "scp", // 日本語タグ名 (必須)

    "name_en": "scp", // 英語タグ名 (存在しない場合はnull)

    "description_raw": "[/scp-series メインブロック]、[/scp-001 001提言]、[/joke-scps Joke(-J)]、[/scp-ex Explained(-EX)]、[/scp-d Decommissioned(-D)]のいずれかに属する[[footnote]]何らかの理由でアーカイブされ、これらの分類から外れた場合も含みます。[[/footnote]]SCP報告書の記事に付与されるタグです。//scp//タグが使用される場合、オブジェクトクラスカテゴリのタグのいずれかと併用されねばなりません。作成に関しては[[[how-to-write:post-scp|]]]を参照してください。", // Wikidot構文を含む生の説明文 (必須)

    "description_plain": "メインブロック、001提言、Joke(-J)、Explained(-EX)、Decommissioned(-D)のいずれかに属するSCP報告書の記事に付与されるタグです。scpタグが使用される場合、オブジェクトクラスカテゴリのタグのいずれかと併用されねばなりません。作成に関してはを参照してください。", // プレーンテキストの説明文 (必須)

    "category_path": ["基本的なタグ", "創作物"], // カテゴリ階層 (必須、ルートからのパス)

    "restrictions": [ // 制限タグ情報 (存在しない場合は空リスト)

      {"icon": "", "meaning": "他の星マーク付きタグと併用不可"} // アイコンと意味

    ],

    "meta": { // 説明文などから抽出したメタ情報

      "related_pages": [ // 関連ページ (Wikidotリンクから)

        {"slug": "scp-series", "display_name": "メインブロック"},

        {"slug": "scp-001", "display_name": "001提言"},

        {"slug": "joke-scps", "display_name": "Joke(-J)"},

        {"slug": "scp-ex", "display_name": "Explained(-EX)"},

        {"slug": "scp-d", "display_name": "Decommissioned(-D)"},

        {"slug": "how-to-write:post-scp", "display_name": null}

      ],

      "related_tags": [ // 関連タグ (説明文から)

        {"slug": "safe", "relation_type": "併用必須（オブジェクトクラス）"}, // relation_typeは仮

        {"slug": "euclid", "relation_type": "併用必須（オブジェクトクラス）"},

        // … 他のオブジェクトクラス

      ],

      "target_page_types": ["scp"], // 対象ページ種別 (説明文から推測)

      "footnotes": [ // 脚注

        "何らかの理由でアーカイブされ、これらの分類から外れた場合も含みます。"

      ],

      "other_notes": [ // その他の注意点

        "オブジェクトクラスカテゴリのタグのいずれかと併用されねばなりません。"

      ]

    },

    "source_location": { // 元ソースの位置情報 (デバッグ用)

       "file": "fragment_tag-list-basic.txt", // どのファイルで定義されているか

       "line": 46 // 何行目か

    }

  },

  // … 他のタグ情報が続く

]

```

## 7. 実装方針（案）

- 既存の `src/parse_jp_tags.py` を大幅に改修、または新規にスクリプトを作成します。
- Wikidot 構文の解析には、複雑さを考慮し、正規表現のみに頼るのではなく、状態管理を組み合わせたカスタムパーサー、あるいは `pyparsing` のような外部ライブラリの利用を検討します。特に、入れ子になった構文（`[[[…]]]` 内の `//…//` など）や、複数行にまたがる可能性のある要素（例: `[[div]]`）に対応できる設計が必要です。
- 説明文からのメタ情報抽出は、複数の専用正規表現パターン、キーワードリスト、および簡単な構文解析ロジックを組み合わせて実装します。自然言語処理 (NLP) ライブラリの導入は、現時点ではオーバースペックと考えられますが、将来的な拡張として検討の余地はあります。
- 処理の各段階（Include 展開、カテゴリ特定、タグ基本情報抽出、メタ情報抽出）を明確に分離した関数やクラスに分割し、テスト容易性と保守性を確保します。
